---
title: "Energetic Consequences of SONAR Exposure"
author: "Max Czapanskiy"
output: pdf_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE,
                      fig.height = 3, fig.width = 5)
```

```{r setup}
library(tidyverse)
library(scales)
library(knitr)
library(kableExtra)
library(lmodel2)
library(ggsci)

# Load data
# Morphological data
morphologies <- read_csv("data/foragestats_combined_ko2.csv") %>% 
  mutate(Species = str_replace(Species, "_", " ")) %>% 
  group_by(Species) %>% 
  summarize(Length_m = first(Body_length_m),
            Mass_kg = first(Body_mass_kg)) %>% 
  mutate(Clade = ifelse(str_detect(Species, ".*ptera.*"),
                        "Mysticete",
                        "Odontocete"),
         Family = recode(Species,
                         `Balaenoptera bonaerensis` = "Balaenopteridae",
                         `Balaenoptera musculus` = "Balaenopteridae",
                         `Balaenoptera physalus` = "Balaenopteridae",
                         `Berardius bairdii` = "Ziphiidae",
                         `Globicephala macrorhynchus` = "Delphinidae",
                         `Globicephala melas` = "Delphinidae",
                         `Grampus griseus` = "Delphinidae",
                         `Megaptera novaeangliae` = "Balaenopteridae",
                         `Mesoplodon densirostris` = "Ziphiidae",
                         `Orcinus orca` = "Delphinidae",
                         `Phocoena phocoena` = "Phocoenidae",
                         `Physeter macrocephalus` = "Physeteridae",
                         `Ziphius cavirostris` = "Ziphiidae"))
# Prey data
prey_data <- read_csv("data/Cetacea model output BOUT_EXTANT_v2.csv") %>% 
  mutate(binomial = paste(Genus, Species),
         binomial = recode(binomial, 
                           `Balaenoptera bonarensis` = "Balaenoptera bonaerensis", 
                           `Physter macrocephalus` = "Physeter macrocephalus", 
                           `Phocoaena Phocaena` = "Phocoena phocoena")) %>% 
  filter(`MR exponent` == 0.45)  # data duplicated for multiple MR exponent values

# Rorqual feeding rates
rorqual_data <- read_csv("data/lunge_rates_from_Paolo.csv") %>%
  filter(species != "be") %>% 
  mutate(duration_h = `deployment-time_secs` / 60 / 60,
         binomial = recode(species,
                           ba = "Balaenoptera bonaerensis",
                           bp = "Balaenoptera physalus",
                           bw = "Balaenoptera musculus",
                           mn = "Megaptera novaeangliae"),
         lunge_h = total_lunges / duration_h)

# Odontocete feeding rates
odontocete_data <- read_csv("data/foragestats_combined_ko2.csv") %>%
  mutate(binomial = str_replace(Species, "_", " ")) %>% 
  filter(taxa == "O") %>% 
  separate(Species, into = c("Genus", "Species"), sep = "_")

abbr_binom = function(binom) {
  paste(str_sub(binom, 1, 1), 
        str_extract(binom, " .*"), 
        sep = ".")
}
binom_levels <- arrange(morphologies, Length_m)$Species
binom_labels <- abbr_binom(binom_levels)
```

## Abstract

This is a tool intended for resource managers to understand some of the sub-lethal effects of SONAR on cetaceans. The model makes a first order approximation by estimating (1) the energy intake lost to foraging cessation and (2) the additional locomotor costs from increased swim speeds. Energetic parameters for the model come from empirical data and theoretical scaling relationships. 

We present the model derivation and apply it to four case studies of typical behavioral responses. *SUMMARY OF RESULTS HERE*.

## Energetic model

The energetic consequences of SONAR exposure, as modeled here, take the form:

$$E_{sonar} = P_{in} \times t_d + P_{out}(U_f) \times t_f$$

Where E~sonar~ is the energy cost of sonar exposure, P~in~ is the rate of energy consumption during undisturbed foraging, t~d~ is the time displaced from foraging, P~out~ is the increased rate of locomotor costs during the flight response relative to undisturbed movement, U~f~ is the animal's speed during flight, and t~f~ is the flight time.

The first term ($P_{in} \times t_d$) is the energy the animal would have consumed during foraging. The second term ($P_{out}(U_f) \times t_f$) is the additional energy spent in elevated locomotion.

## Rate of consumption ($P_{in}$)

The rate of consumption is the product of feeding rates and prey quality. We estimated feeding rates from tag data (lunges for rorquals, buzzes for odontocetes) and prey quality from active acoustics (rorquals) or stomach contents (odontocetes).

### Empirical feeding rates

Prey data from "Cetacea model output BOUT_EXTANT_v2.csv".

#### Mysticetes

The mysticete feeding rate is defined as the mean number of lunges per hour of deployment for deployments exceeding 24 hours. Shorter deployments tend to have higher lunge rates due to diel foraging patterns. Overall, lunge rates decrease with body size.

```{r bw_feeding_rate, results="asis"}
lungerate <- rorqual_data %>% 
  filter(duration_h >= 24) %>%
  group_by(Species = binomial) %>% 
  summarize(N = n(),
            `Lunge rate` = round(mean(lunge_h), digits = 1))

kable(lungerate, "latex", booktabs = TRUE)
```

```{r}
rorqual_data %>% 
  mutate(dur_cat = factor(ifelse(duration_h < 24, "< 1 day", "> 1 day"),
                          levels = c("< 1 day", "> 1 day")),
         binomial = factor(binomial, 
                           levels = binom_levels, 
                           labels =  abbr_binom(binom_labels))) %>% 
  ggplot(aes(binomial, lunge_h, fill = dur_cat)) +
  geom_boxplot() +
  geom_point(shape = 21,
             position = position_jitterdodge()) +
  scale_fill_aaas() +
  labs(y = "Lunges per hour") +
  theme_classic(base_size = 8) +
  theme(axis.title.x = element_blank(),
        legend.title = element_blank(),
        legend.position = c(0.7, 0.7))
```

#### Odontocetes

Odontocetes forage with echolocation so feeding events are identifiable by an acoustic signature. Feeding rates are estimated as buzzes per hour. The tagging durations on odontocetes were not as long as mysticetes, so I used all available data. The relationship between feeding rates and body size is more variable than for mysticetes. This makes sense given the wider range of prey and dive depths for odontocetes.

```{r, results = "asis"}
odontocete_data %>%  
  group_by(Species = binomial) %>% 
  summarize(N = n(),
            `Buzz rate (per hour)` = (total_buzz_count / total_duration_h) %>% 
              mean(na.rm = TRUE) %>% 
              round(digits = 1)) %>% 
  kable("latex", booktabs = TRUE)
```

```{r}
odontocete_data %>% 
  filter(binomial != "Phocoena phocoena") %>% 
  left_join(select(morphologies, Species, Family, Length_m), 
            by = c(binomial = "Species")) %>%
  mutate(buzz_h = total_buzz_count / total_duration_h,
         binomial = factor(binomial,
                           levels = binom_levels,
                           labels = binom_labels)) %>%
  ggplot(aes(binomial, buzz_h, fill = Family)) +
  geom_boxplot() +
  geom_point(shape = 21,
             position = position_jitter()) +
  scale_fill_aaas() +
  labs(y = "Buzzes per hour",
       caption = "P. phocoena not shown, mean buzz rate = 96.8/hr") +
  theme_classic(base_size = 8) +
  theme(axis.title.x = element_blank(),
        axis.text.x = element_text(hjust = 1,
                                   angle = 45),
        legend.title = element_blank(),
        legend.position = c(0.8, 0.85))
```
