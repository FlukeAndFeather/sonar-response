---
title: "Energetic Consequences of Sonar Exposure"
author: "Max Czapanskiy"
output: pdf_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(echo=FALSE, warning=FALSE, message=FALSE,
                      fig.height = 3, fig.width = 4)
```

```{r setup}
library(tidyverse)
library(scales)
library(knitr)
library(kableExtra)
library(lmodel2)
library(ggsci)
```

What are the energetic consequences for cetaceans when exposed to sonar? The following model makes a first order approximation by estimating (1) the energy intake lost to foraging cessation and (2) the additional energy expenditure from increased swim speeds. We considered these two factors in four potential scenarios: 

1. No response
2. Cessation of foraging without flight
3. Cessation of foraging with flight
4. Extreme response

The model will be paramterized using data and models from other sources (see table at the end of this document). Functional responses (e.g. displacement distance and duration) will come from the literature. The energy cost of lost feeding opportunities will be estimated with the scaling relationships in Jeremy's scaling paper. The energy cost of increased swim speeds during flight will be estimated using models from Williams et al. 2017. Thus:

$$E_{sonar} = P_{in} \times t_d + P_{out} \times t_f$$

Where E~sonar~ is the energy cost of sonar exposure, P~in~ is the rate of energy intake when foraging, t~d~ is the displacement time, P~out~ is the increase in energy expenditure from locomotion due to the flight response, and t~f~ is the flight time.

# Functional responses

*In progress*

```{r fun_resp}

```

# Energetic parameters

I'm estimating P~in~ as the product of energy acquired per feeding event (E~p~) and feeding rate (r~f~). Energy acquired from prey scales sublinearly among odontocetes [E~p~=0.12M~c~^0.81^] but superlinearly among mysticetes [E~p~=5.83M~c~^2.37^]. *Note: Jeremy's paper has a negative coefficient for mysticete E~p~ scaling (v8.3:115) but I think that's a mistake.*

```{r Ep_scaling}
# Vaquita to sperm whale
odo_m_rng <- c(50, 41e3)
# Minke to blue whale (eyeballed from Kahane-Rapport and Goldbogen 2018, Fig 2)
mys_m_rng <- c(10^3.6, 10^5.25)

Ep_fun <- function(m, clade) {
  ifelse(clade == "Odontocete", 
         0.12 * m ^ 0.81, 
         5.83 * m ^ 2.37)
}

Ep_tbl <- tibble(M = c(odo_m_rng, mys_m_rng),
                 Clade = factor(c(rep("Odontocete", 2), rep ("Mysticete", 2))),
                 Ep = Ep_fun(M, Clade))

ggplot(Ep_tbl, aes(M, Ep, color = Clade)) + 
  geom_line(size = 2) +
  scale_x_log10(name = "Mass (kg)",
                labels = trans_format("log10", math_format(10 ^ .x))) +
  scale_y_log10(name = "Energy from prey (Joules?)",
                labels = trans_format("log10", math_format(10 ^ .x))) +
  scale_color_brewer(type = "qual", palette = 6) +
  theme_classic() +
  theme(legend.position = c(.2, .8))
```

*If I understand correctly, E~p~ is energy per feeding event. But how do I get feeding rate? Figure 2 in Jeremy's paper has [feeding events / dive] ~ [dive time - TADL]. Can we get feeding rates from something like that?*

## Empirical feeding rates

Prey data from "Cetacea model output BOUT_EXTANT.csv". NOTE: *Ziphius* prey data doesn't sum to 100%.

```{r feeding_rates, results = "asis"}
study_species <- c("Balaenoptera musculus",   # Blue whale
                   "Berardius bairdii",       # Baird's beaked whale
                   "Mesoplodon densirostris", # Blainville's beaked whale
                   "Ziphius cavirostris")     # Cuvier's beaked whale
prey_data <- read_csv("data/Cetacea model output BOUT_EXTANT.csv") %>% 
  mutate(binomial = paste(Genus, Species)) %>% 
  filter(binomial %in% study_species,
         `MR exponent` == 0.45)  # data duplicated for multiple MR exponent values

# NOTE: Ziphius prey data doesn't sum to 100% 
prey_data %>% 
  group_by(binomial) %>%
  summarize(SumPercent = sum(Percent)) %>% 
  rename(Species = binomial, `Sum of prey percentages` = SumPercent) %>% 
  kable("latex", booktabs = TRUE)
```

### Blue whales

```{r bw_feeding_rate}
rorqual_data <- read_csv("data/lunge_rates_from_Paolo.csv") %>%
  filter(species == "bw") %>% 
  mutate(duration_h = `deployment-time_secs` / 60 / 60,
         binomial = "Balaenoptera musculus",
         lunge_h = total_lunges / duration_h)

bw_lungerate <- rorqual_data %>% 
  filter(duration_h >= 24) %>%
  summarize(lunge_rate = mean(lunge_h)) %>% 
  `[[`(1) %>% 
  round(digits = 1)
```

How should lunge rate be calculated? Lunge rates from tags that lasted more than a day are lower because they capture night time. Should we use the mean lunge rate from <1 day tags because that's the opportunity cost? Or should we use the mean lunge rate from >1 day tags to be conservative? I'm going with the latter for now, which is *`r bw_lungerate` lunges/hour*.

```{r}
rorqual_data %>% 
  mutate(dur_cat = factor(ifelse(duration_h < 24, "< 1 day", "> 1 day"),
                          levels = c("< 1 day", "> 1 day"))) %>% 
  ggplot(aes(dur_cat, lunge_h)) +
  geom_boxplot() +
  geom_jitter(width = 0.2, height = 0) +
  labs(y = "Lunges per hour") +
  theme_classic() +
  theme(axis.title.x = element_blank())
```

### Beaked whales
```{r beaked_feeding_rates}
odontocete_data <- read_csv("data/foragestats_combined_ko2.csv") %>%
  mutate(binomial = str_replace(Species, "_", " ")) %>% 
  filter(taxa == "O",
         binomial %in% study_species) %>% 
  separate(Species, into = c("Genus", "Species"), sep = "_")
```

We have limited beaked whale data. Mean hourly feeding rates are 4.6 for *Berardius* (but N = 1) and ~13 for *Mesoplodon* and *Ziphius*.

```{r, results = "asis"}
odontocete_data %>%  
  group_by(Species = binomial) %>% 
  summarize(N = n(),
            `Buzz rate (per hour)` = (total_buzz_count / total_duration_h) %>% 
              mean %>% 
              round(digits = 1)) %>% 
  kable("latex", booktabs = TRUE)
```

## Empirical prey size distributions

Blue whales engulf several orders of magnitude more energy per feeding event than beaked whales (no surprise there).

```{r fig.width=5}
prey_data %>%
  mutate(binomial = str_replace(binomial, " ", "\n")) %>% 
  uncount(weights = Percent) %>% 
  ggplot(aes(binomial, `Energy (kJ)`)) +
  geom_boxplot() +
  scale_y_log10(name = "Energy (kJ)",
                labels = comma) +
  theme_classic() +
  theme(axis.title.x = element_blank())
```

## Power in

$$P_{in} = E_{p} \times r_{f}$$

Where P~in~ is the rate of energy intake (kJ/hour), E~p~ is the energy from in one feeding event (kJ), and r~f~ is the feeding rate (feeding events/hour). The following figure shows estimates of P~in~ for the four study species. Error bars are calculated as $(mean(E_p) \pm sd(E_p)) \times r_f$.

```{r fig.width=4.5}
Ep_tbl <- prey_data %>%
  uncount(weights = Percent) %>% 
  group_by(binomial) %>% 
  summarize(Ep = mean(`Energy (kJ)`),
            EpH = Ep + sd(`Energy (kJ)`),
            EpL = Ep - sd(`Energy (kJ)`))

rf_tbl <- rorqual_data %>% 
  filter(duration_h >= 24) %>%
  group_by(binomial) %>% 
  summarize(rf = round(mean(lunge_h), 1)) %>% 
  rbind(odontocete_data %>%  
          group_by(binomial) %>% 
          summarize(rf = round(mean(total_buzz_count / total_duration_h), 1)))

Pin_tbl <- inner_join(Ep_tbl, rf_tbl, by = "binomial") %>% 
  mutate(Pin = Ep * rf,
         PinL = EpL * rf,
         PinH = EpH * rf)

Pin_tbl %>% 
  mutate(binomial = str_replace(binomial, " ", "\n")) %>% 
  ggplot(aes(x = binomial)) +
  geom_col(aes(y = Pin)) +
  geom_errorbar(aes(ymin = PinL,
                    ymax = PinH),
                width = 0.25) +
  scale_y_log10(name = "Energy (kJ)",
                labels = comma) +
  theme_classic() +
  theme(axis.title.x = element_blank())
```

## Power out

$$P_{out} = f_f \times m \times (C_{L.max} - C_{L.pref})$$

Where f~f~ is the fluking frequency, **m** is the mass of the animal, C~L.max~ is the mass-specific cost of locomotion at maximum energetic output and C~L.pref~ is the cost of locomotion at the prefered energetic output. Williams et al. 2017 calculated C~L~ as:

$$C_{L.pref} = 1.46 + 0.0005m \\
C_{L.max} = 5.17 + 0.0002m$$

(see equations 6 and 7)

### Fluking frequencies
```{r}
# Load fluking data
# Frank's data
odontocete_fluking <- read_csv('data/Data From Frank.csv') %>% 
  mutate(binomial = recode(Species,
                           "D. leucas" = "Delphinapterus leucas",
                      "G. macrorhynchus" = "Globicephala macrorhynchus",
                      "L. obliquidens" = "Lagenorhynchus obliquidens",
                      "O. orca" = "Orcinus orca",
                      "P. crassidens" = "Pseudorca crassidens",
                      "S. ceruleoalba" = "Stenella coeruleoalba",
                      "T. truncatus" = "Tursiops truncatus"))

# Will's data. Conversion from XLSX was messy
mysticete_fluking <- read_csv('data/Whale PRH Master List.csv') %>% 
  slice(1:60) %>% 
  select(-(X27:X33)) %>% 
  mutate(species_code = str_sub(`Deployment Name`, 1, 2),
         binomial = recode(species_code,
                           bb = "Balaenoptera bonaerensis",
                           be = "Balaenoptera edeni",
                           bp = "Balaenoptera physalus",
                           bw = "Balaenoptera musculus",
                           mn = "Megaptera novaeangliae"))

# Standard major axis regression
SMA <- 3
odontocete_model <- lmodel2(log10(`Frequency (Hz)`) ~ log10(`Length (m)`),
                            data = odontocete_fluking)
odontocete_coef <- odontocete_model$regression.results[SMA,]
mysticete_model <- lmodel2(log10(`Tailbeat Frequency (Hz)`) ~ log10(`Length`),
                            data = mysticete_fluking)
mysticete_coef <- mysticete_model$regression.results[SMA,]
```

Fluking frequency in odontocetes scales with length as $log_{10}(f)=-1.686 \times log_{10}(m) + 1.062$.
```{r fig.width=5.5, fig.height=4}
ggplot(odontocete_fluking, aes(`Length (m)`, `Frequency (Hz)`)) +
  geom_point(aes(color = Species)) +
  geom_abline(intercept = odontocete_coef$Intercept,
              slope = odontocete_coef$Slope,
              linetype = "dashed") +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = expression(log[10](Length) * " " * (m)),
       y = expression(log[10](Frequency) * " " * (Hz)),
       color = "Species") +
  theme_classic() +
  guides(color = guide_legend(nrow = 2)) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

Fluking frequency in mysticetes scales with length as $log_{10}(f)=-0.529 \times log_{10}(m) - 0.038$.

```{r fig.width=5.5, fig.height=4}
mysticete_fluking %>% 
  mutate(abbr = paste(str_sub(binomial, 1, 1), 
                      str_extract(binomial, " .*"), 
                      sep = ".")) %>% 
  ggplot(aes(`Length`, `Tailbeat Frequency (Hz)`)) +
  geom_point(aes(color = abbr)) +
  geom_abline(intercept = mysticete_coef$Intercept,
              slope = mysticete_coef$Slope,
              linetype = "dashed") +
  scale_x_log10() +
  scale_y_log10() +
  labs(x = expression(log[10](Length) * " " * (m)),
       y = expression(log[10](Frequency) * " " * (Hz)),
       color = "Species") +
  theme_classic() +
  guides(color = guide_legend(nrow = 2)) +
  theme(legend.position = "bottom",
        legend.title = element_blank())
```

They don't look terribly similar when plotted together.

```{r}
odontocete_line <- odontocete_fluking %>% 
  summarize(L1 = min(`Length (m)`),
            L2 = max(`Length (m)`)) %>% 
  mutate(F1 = 10^(log10(L1) * odontocete_coef$Slope + odontocete_coef$Intercept),
         F2 = 10^(log10(L2) * odontocete_coef$Slope + odontocete_coef$Intercept),
         clade = "odontocete")
mysticete_line <- mysticete_fluking %>% 
  summarize(L1 = min(Length),
            L2 = max(Length)) %>% 
  mutate(F1 = 10^(log10(L1) * mysticete_coef$Slope + mysticete_coef$Intercept),
         F2 = 10^(log10(L2) * mysticete_coef$Slope + mysticete_coef$Intercept),
         clade = "mysticete")
sma_lines = rbind(odontocete_line, mysticete_line)
transmute(odontocete_fluking,
          length = `Length (m)`, 
          freq = `Frequency (Hz)`,
          abbr = Species,
          clade = "Odontocete") %>% 
  rbind(transmute(mysticete_fluking,
                  length = Length,
                  freq = `Tailbeat Frequency (Hz)`,
                  abbr = paste(str_sub(binomial, 1, 1), 
                               str_extract(binomial, " .*"), 
                               sep = "."),
                  clade = "Mysticete")) %>% 
  ggplot(aes(length, freq)) +
  geom_point(aes(color = clade)) +
  geom_segment(aes(x = L1, y = F1,
                   xend = L2, yend = F2),
               sma_lines,
               linetype = "dashed") +
  scale_x_log10() +
  scale_y_log10() +
  scale_color_aaas() +
  labs(x = expression(log[10](Length) * " " * (m)),
       y = expression(log[10](Frequency) * " " * (Hz))) +
  theme_classic() +
  theme(legend.position = c(0.75, 0.75),
        legend.title = element_blank())
```

These scaling relationships give us the following fluking frequencies:

```{r results="asis"}
morphologies <- read_csv("data/foragestats_combined_ko2.csv") %>% 
  mutate(Species = str_replace(Species, "_", " ")) %>% 
  filter(Species %in% study_species) %>% 
  group_by(Species) %>% 
  summarize(Length = first(Body_length_m),
            Mass = first(Body_mass_kg))

scale_fluke_freq <- function(clade, length) {
  myst_slope <- mysticete_coef$Slope
  myst_int <- mysticete_coef$Intercept
  odont_slope <- odontocete_coef$Slope
  odont_int <- odontocete_coef$Intercept
  ifelse(clade == "M",
         10 ^ (log10(length) * myst_slope + myst_int),
         10 ^ (log10(length) * odont_slope + odont_int))    
}

fluke_freq_tbl <- morphologies %>% 
  select(Species, Length) %>% 
  mutate(clade = ifelse(Species == "Balaenoptera musculus",
                        "M", "O"),
         FlukeFreq = scale_fluke_freq(clade, Length)) %>%
  select(-clade)

fluke_freq_tbl %>% 
  mutate(FlukeFreq = round(FlukeFreq, 3)) %>%
  rename(`Length (m)` = Length,
         `Fluking frequency (Hz)` = FlukeFreq) %>% 
  kable("latex", booktabs = TRUE)
```

# Literature
```{r lit, results = "asis"}
refs <- tibble(Reference = c("Tyack et al. 2011", "DeRuiter et al. 2017", "DeRuiter et al. 2013", "Friedlaender et al. 2016", "Goldbogen et al. 2013", "Kvadsheim et al. 2017", "Southall et al. 2019"),
               Species = c("Mesoplodon densirostris", "Balaenoptera musculus", "Ziphius cavirostris", "Balaenoptera musculus", "Balaenoptera musculus", "Balaenoptera acutorostrata", "Ziphius cavirostris"),
               Tags = c(1, 37, 2, 9, 17, 4, 0),
               Notes = c("Only 1 tag, but other data from sonar array", "How did the transition probability from deep feeding to other states change in CEEs?", "Reduced time foraging in response to proximal sonar, but not distant", "Includes prey data", "Basis for Friedlaender et al. 2016 and DeRuiter et al. 2017", "SoCal + Norway. 1 CEE + 1 control in each location", "Prey distribution in SoCal sonar array"))

kable(refs, "latex", booktabs = TRUE) %>% 
  column_spec(4, width = "18em")
```
